<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GG-Tracker • TuttiFrutti vs. Pepperoncini</title>
<style>
:root{--bg:#0b1020;--fg:#e5e7eb;--mut:#9ca3af;--p:#0f172a;--b:#1f2937;--a:#60a5fa;--g:#22c55e;--r:#ef4444}
@media(prefers-color-scheme:light){:root{--bg:#f8fafc;--fg:#111827;--mut:#4b5563;--p:#fff;--b:#e5e7eb;--a:#2563eb;--g:#16a34a;--r:#dc2626}}
*{box-sizing:border-box}
body{margin:0;font:14px system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--fg)}
header{position:sticky;top:0;background:rgba(0,0,0,.1);backdrop-filter:blur(6px);border-bottom:1px solid var(--b)}
.wrap{max-width:980px;margin:auto;padding:10px}
.h{display:flex;gap:8px;justify-content:space-between;align-items:center}
.btn{border:1px solid var(--b);background:var(--p);color:var(--fg);border-radius:10px;padding:6px 8px;cursor:pointer}
.primary{background:var(--a);border-color:transparent;color:#fff}
.good{background:var(--g);border-color:transparent;color:#fff}
.bad{background:var(--r);border-color:transparent;color:#fff}
.grid{display:grid;gap:10px;grid-template-columns:2fr 1fr}
.card{background:var(--p);border:1px solid var(--b);border-radius:14px;padding:12px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.score{font-size:28px;font-weight:800}
.small{color:var(--mut);font-size:12px}
.pill{border:1px solid var(--b);border-radius:999px;padding:2px 8px}
.table{width:100%;border-collapse:collapse}
.table td{border-top:1px solid var(--b);padding:4px}
#log{max-height:160px;overflow:auto}
</style>
</head>
<body>
<header>
  <div class="wrap h">
    <b>GG-Tracker</b><span class="small">TuttiFrutti vs. Pepperoncini</span>
    <div class="row">
      <button id="export" class="btn">Export</button>
      <button id="import" class="btn">Import</button>
      <button id="wipe" class="btn bad">Reset</button>
      <span class="pill" id="ghStatus">offline</span>
      <button id="ghLogin" class="btn">GitHub Login</button>
      <button id="ghSave" class="btn">Save→GitHub</button>
      <button id="ghLoad" class="btn">Load←GitHub</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">
    <section class="card">
      <h3>Tag</h3>
      <div class="row small">
        <label>Datum: <input id="dayLabel"/></label>
        <label><input id="validDay" type="checkbox" checked> beide von Anfang an</label>
        <label><input id="validTeams" type="checkbox" checked> Teamaufteilung gültig</label>
      </div>
      <div class="row" style="justify-content:space-between;margin-top:6px">
        <div><b>TuttiFrutti</b> <span id="sA" class="score">0</span></div>
        <div><b>Pepperoncini</b> <span id="sB" class="score">0</span></div>
      </div>

      <div class="row" style="margin-top:6px">
        <button data-p="A" data-a="r" class="btn primary">Messer Random +1</button>
        <button data-p="A" data-a="rv" class="btn primary">Messer Rival +2</button>
        <button data-p="A" data-a="gk" class="btn">Messer GK +1</button>
        <button data-p="A" data-a="bot" class="btn bad">Messer BOT −1</button>
        <button data-p="A" data-a="mid" class="btn">Messerung +1</button>
        <button data-p="A" data-a="kick" class="btn good">Gekickt +2</button>
        <button data-p="A" data-a="leave" class="btn bad">Verlassen −1</button>
      </div>

      <div class="row" style="margin-top:4px">
        <button data-p="B" data-a="r" class="btn primary">Messer Random +1</button>
        <button data-p="B" data-a="rv" class="btn primary">Messer Rival +2</button>
        <button data-p="B" data-a="gk" class="btn">Messer GK +1</button>
        <button data-p="B" data-a="bot" class="btn bad">Messer BOT −1</button>
        <button data-p="B" data-a="mid" class="btn">Messerung +1</button>
        <button data-p="B" data-a="kick" class="btn good">Gekickt +2</button>
        <button data-p="B" data-a="leave" class="btn bad">Verlassen −1</button>
      </div>

      <div class="row" style="justify-content:space-between;margin-top:6px">
        <button id="invalidate" class="btn">Runde ungültig</button>
        <div class="row">
          <button id="end" class="btn primary">Tag abschließen</button>
          <button id="resetDay" class="btn">Tag zurücksetzen</button>
        </div>
      </div>
      <p class="small">Regel: Tagessieg nur bei Differenz ≥ 2. Jeder gültige Tagessieg → +2 CHF.</p>
      <div id="log" class="card small"></div>
      <div class="card" style="margin-top:8px">
        <h4 style="margin:0 0 6px 0">Offene Einträge (beide bestätigen)</h4>
        <div id="pending" class="row" style="flex-direction:column;align-items:stretch;gap:6px"></div>
      </div>
    </section>

    <aside class="card">
      <h3>Guthaben</h3>
      <table class="table"><tbody>
        <tr><td>TuttiFrutti</td><td id="balA">0.00 CHF</td></tr>
        <tr><td>Pepperoncini</td><td id="balB">0.00 CHF</td></tr>
      </tbody></table>
      <p class="small">Lokal gespeichert · Export/Import oder GitHub-Sync.</p>
    </aside>
  </div>
</main>

<script>
const $=s=>document.querySelector(s),
log=m=>{const d=document.createElement('div');d.textContent=new Date().toLocaleTimeString()+' — '+m;$('#log').prepend(d)};
const state={day:{A:0,B:0,valid:true,teams:true,label:new Date().toISOString().slice(0,10)},bal:{A:0,B:0},q:[]};
const save=_=>localStorage.setItem('ggstats',JSON.stringify(state));
const load=_=>{try{Object.assign(state,JSON.parse(localStorage.getItem('ggstats')||'{}'))}catch{}}
const delta=a=>({r:1,rv:2,gk:1,bot:-1,mid:1,kick:2,leave:-1}[a]||0);

function render(){
 $('#sA').textContent=state.day.A; $('#sB').textContent=state.day.B;
 $('#balA').textContent=state.bal.A.toFixed(2)+' CHF'; $('#balB').textContent=state.bal.B.toFixed(2)+' CHF';
 $('#dayLabel').value=state.day.label; $('#validDay').checked=state.day.valid; $('#validTeams').checked=state.day.teams;
 const box=$('#pending'); box.innerHTML='';
 state.q.forEach(it=>{
  const row=document.createElement('div');row.className='row';row.style.justifyContent='space-between';
  const txt=document.createElement('div');txt.textContent=`${it.reason} (${it.d>=0?'+':''}${it.d}) → ${it.p==='A'?'TuttiFrutti':'Pepperoncini'}`;
  const act=document.createElement('div');act.className='row';
  const bA=btn('TuttiFrutti',_=>conf(it,'A'),it.c.A);
  const bB=btn('Pepperoncini',_=>conf(it,'B'),it.c.B);
  const del=btn('verwerfen',_=>drop(it),false,'bad');
  act.append(bA,bB,del);row.append(txt,act);box.append(row);
  if(it.c.A&&it.c.B)apply(it);
 });
}
const btn=(t,fn,dis,cls='')=>{const b=document.createElement('button');b.className='btn '+cls;b.textContent=dis?t+' ✓':t+' bestätigen';b.disabled=!!dis;b.onclick=fn;return b};
function add(p,d,reason){state.q.push({id:Math.random().toString(36).slice(2),p,d,reason,c:{A:false,B:false}});save();render();log(`Neu: ${reason} → ${p==='A'?'TuttiFrutti':'Pepperoncini'} ${d>=0?'+':''}${d}`);}
const conf=(it,who)=>{it.c[who]=true;save();render();};
const drop=it=>{state.q=state.q.filter(x=>x.id!==it.id);save();render();log('Eintrag verworfen.')};
const apply=it=>{state.day[it.p]+=it.d;state.q=state.q.filter(x=>x.id!==it.id);save();render();log(`Bestätigt: ${it.reason}`)};
function endDay(){
 if(state.q.length)return alert('Offene Einträge zuerst bestätigen.');
 if(!state.day.valid||!state.day.teams){log('Tag ungültig – kein Guthaben.');return resetDay();}
 const diff=Math.abs(state.day.A-state.day.B);
 if(diff<2)return alert('Differenz < 2. Verlierer darf weitere Runde einfordern.');
 const w=state.day.A>state.day.B?'A':'B';
 state.bal[w]+=2;log(`Tag abgeschlossen → +2 CHF für ${w==='A'?'TuttiFrutti':'Pepperoncini'}`);resetDay();
}
function resetDay(){state.day={A:0,B:0,valid:true,teams:true,label:new Date().toISOString().slice(0,10)};save();render();log('Tag zurückgesetzt.');}
load();render();
addEventListener('click',e=>{const b=e.target.closest('button');if(!b)return;const a=b.dataset.a,p=b.dataset.p;if(!a)return;add(p,delta(a),label(a));});
$('#end').onclick=endDay;$('#resetDay').onclick=resetDay;$('#invalidate').onclick=_=>{state.day.valid=false;save();render();log('Runde ungültig markiert.')};
$('#export').onclick=_=>{const u=URL.createObjectURL(new Blob([JSON.stringify(state)],{type:'application/json'}));const a=document.createElement('a');a.href=u;a.download='ggstats.json';a.click();URL.revokeObjectURL(u)};
$('#import').onclick=_=>{const i=document.createElement('input');i.type='file';i.accept='application/json';i.onchange=_=>{const f=i.files[0];if(!f)return;const r=new FileReader();r.onload=_=>{try{Object.assign(state,JSON.parse(r.result));save();render();log('Import erfolgreich.');}catch{alert('Import fehlgeschlagen.');}};r.readAsText(f)};i.click();};
$('#wipe').onclick=_=>{if(confirm('Alle Daten löschen?')){localStorage.removeItem('ggstats');location.reload();}};
$('#dayLabel').oninput=e=>{state.day.label=e.target.value;save();};
$('#validDay').onchange=e=>{state.day.valid=e.target.checked;save();};
$('#validTeams').onchange=e=>{state.day.teams=e.target.checked;save();};
function label(a){return{r:'Messer Random',rv:'Messer Rival',gk:'Messer GK',bot:'Messer BOT',mid:'Messerung',kick:'Gekickt',leave:'Verlassen'}[a]||'Aktion';}

// === GitHub OAuth (Device Flow) + JSON commit ===
const GH={client_id:'YOUR_GITHUB_OAUTH_CLIENT_ID',owner:'YOUR_GITHUB_USER',repo:'YOUR_REPO',path:'data/ggstats.json',token:null};
async function ghLogin(){
 const r=await fetch('https://github.com/login/device/code',{method:'POST',headers:{'Accept':'application/json','Content-Type':'application/json'},body:JSON.stringify({client_id:GH.client_id,scope:'repo'})});
 const d=await r.json();if(!d.device_code)return alert('OAuth start fehlgeschlagen');
 alert(`GitHub Login:\n1) Öffne https://github.com/login/device\n2) Code eingeben: ${d.user_code}`);
 $('#ghStatus').textContent='auth...';
 let token=null;
 while(!token){await wait(d.interval*1000);
  const t=await fetch('https://github.com/login/oauth/access_token',{method:'POST',headers:{'Accept':'application/json','Content-Type':'application/json'},body:JSON.stringify({client_id:GH.client_id,device_code:d.device_code,grant_type:'urn:ietf:params:oauth:grant-type:device_code'})});
  const j=await t.json();
  if(j.access_token){token=j.access_token;break;}
  if(j.error&&j.error!=='authorization_pending')return alert('Login abgebrochen: '+j.error);
 }
 GH.token=token;localStorage.setItem('gh_token',token);$('#ghStatus').textContent='online';log('GitHub: angemeldet.');
}
async function ghGet(path){
 const url=`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}`;
 const res=await fetch(url,{headers:{'Accept':'application/vnd.github+json','Authorization':`Bearer ${GH.token}`}});
 if(res.status===404)return{sha:null,content:null};
 const j=await res.json();
 const decoded=j.content?atob(j.content.replace(/\\n/g,'')):null;
 return{sha:j.sha,content:decoded};
}
async function ghPut(path,content,sha){
 const url=`https://api.github.com/repos/${GH.owner}/${GH.repo}/contents/${path}`;
 const body={message:'update ggstats.json',content:btoa(unescape(encodeURIComponent(content))),sha};
 const res=await fetch(url,{method:'PUT',headers:{'Accept':'application/vnd.github+json','Authorization':`Bearer ${GH.token}`,'Content-Type':'application/json'},body:JSON.stringify(body)});
 if(!res.ok){throw new Error(await res.text());}
}
async function ghSave(){
 if(!GH.token)return alert('Bitte zuerst GitHub Login.');
 const cur=await ghGet(GH.path);
 await ghPut(GH.path,JSON.stringify(state),cur.sha||undefined);
 log('GitHub: Daten gespeichert.');
}
async function ghLoad(){
 if(!GH.token)return alert('Bitte zuerst GitHub Login.');
 const cur=await ghGet(GH.path);
 if(!cur.content)return alert('Keine Daten gefunden.');
 try{Object.assign(state,JSON.parse(cur.content));save();render();log('GitHub: Daten geladen.');}
 catch(e){alert('JSON ungültig.');}
}
function wait(ms){return new Promise(r=>setTimeout(r,ms));}
GH.token=localStorage.getItem('gh_token');if(GH.token)$('#ghStatus').textContent='online';
$('#ghLogin').onclick=ghLogin;$('#ghSave').onclick=ghSave;$('#ghLoad').onclick=ghLoad;
</script>
</body>
</html>
